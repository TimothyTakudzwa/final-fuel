///Take from user.views line 838

@login_required()
def export_pdf(request):
    result = ''
    if request.method == "POST":
        print(request.POST.get('type_model'))
        if request.POST.get('type_model') == "stock":
            data = FuelUpdate.objects.filter(company_id=request.user.company.id)
        if request.POST.get('type_model') == "transaction":
            print('------------------Im In Here---------------------------')
            start = request.POST.get('start')
            end = request.POST.get('end')
            start = datetime.strptime(start, '%b. %d, %Y').date()
            end = datetime.strptime(end, '%b. %d, %Y').date()

            data = Transaction.objects.filter(date__range=[start, end])


            for i in data:
                result += f'Date : {i.date}\n Time : {i.time}\n Buyer : {i.buyer}\n Completed : {i.is_complete}\n'
            pdf = FPDF(orientation='P', format='A5')
            pdf.add_page()
            epw = pdf.w - 2*pdf.l_margin
            col_width = epw/4

            pdf.set_font('Times', '', 10)
            # pdf.image('project/static/project/img/receipt.png', x=40)
            pdf.multi_cell(w=100, h=10, txt=result)
            pdf.output(f'media/reports/transactions/Report - {datetime.now().strftime("%Y-%M-%d")}.pdf', 'F')
        if request.POST.get('type_model') == "reqs":
            print('-------------------------Im in FuelRequests----------------------')
            start = request.POST.get('start')
            end = request.POST.get('end')
            start = datetime.strptime(start, '%b. %d, %Y').date()
            end = datetime.strptime(end, '%b. %d, %Y').date()

            data = FuelRequest.objects.filter(date__range=[start, end])


            for i in data:
                result += f'Name : {i.name}\n Amount : {i.amount}\n Fuel Type : {i.fuel_type}\n Payment Method : {i.payment_method}\n'
            pdf = FPDF(orientation='P', format='A5')
            pdf.add_page()
            epw = pdf.w - 2*pdf.l_margin
            col_width = epw/4

            pdf.set_font('Times', '', 10)
            # pdf.image('project/static/project/img/receipt.png', x=40)
            pdf.multi_cell(w=100, h=10, txt=result)
            pdf.output(f'media/reports/requests/Report - {datetime.now().strftime("%Y-%M-%d")}.pdf', 'F')

        if request.POST.get('type_model') == "revenue":
            start = request.POST.get('start')
            end = request.POST.get('end')
            start = datetime.strptime(start, '%b. %d, %Y').date()
            end = datetime.strptime(end, '%b. %d, %Y').date()

            data = Transaction.objects.filter(date__range=[start, end])





        return redirect('users:report_generator')

def html_to_pdf(request):
    data = {'trans': Transaction.objects.all()}
    template = get_template("users/report.html")
    html  = template.render(data)
    # context = {'pagesize':'A4'}
    # html = template.render(context) 
    # result = StringIO() 
    # pdf = pisa.pisaDocument(StringIO(html), dest=result) 
    # if not pdf.err: 
    #     return HttpResponse(result.getvalue(), content_type='application/pdf') 
    # else: return HttpResponse('Errors')
    file = open('test.pdf', "w+b")
    pisaStatus = pisa.CreatePDF(html.encode('utf-8'), dest=file,
            encoding='utf-8')

    file.seek(0)
    pdf = file.read()
    file.close()
    return HttpResponse(pdf, 'application/pdf')


"""
Users App, Allocate Diesel
"""
    
@login_required()
def allocate_diesel(request, id):
    if request.method == 'POST':
        if F_Update.objects.filter(id=id).exists():
            diesel_update = F_Update.objects.filter(id=id).first()
            diesel_update.diesel_quantity = diesel_update.diesel_quantity + int(request.POST['diesel_quantity'])
            company_quantity = F_Update.objects.filter(company_id=request.user.company.id).filter(
                sub_type='Company').first()
            if int(request.POST['diesel_quantity']) > company_quantity.diesel_quantity:
                messages.warning(request,
                                 f'You can not allocate fuel above your company diesel capacity of {company_quantity.diesel_quantity}')
                return redirect('users:allocate')

            company_quantity.diesel_quantity = company_quantity.diesel_quantity - int(request.POST['diesel_quantity'])
            company_quantity.save()
            diesel_update.save()
            assigned_staff = user.objects.filter(subsidiary_id=diesel_update.relationship_id).first()
            if assigned_staff is not None:
                action = 'Allocation of Diesel'
                FuelAllocation.objects.create(company=request.user.company, action=action,
                                              diesel_price=diesel_update.diesel_price,
                                              diesel_quantity=request.POST['diesel_quantity'],
                                              sub_type=diesel_update.sub_type, cash=request.POST['cash'],
                                              usd=request.POST['usd'], swipe=request.POST['swipe'],
                                              ecocash=request.POST['ecocash'],
                                              allocated_subsidiary_id=assigned_staff.subsidiary_id)
                messages.success(request, 'Updated diesel quantity successfully')
                service_station = Subsidiaries.objects.filter(id=diesel_update.relationship_id).first()
                reference = 'fuel allocation'
                reference_id = diesel_update.id
                action = f"You have allocated diesel quantity of {int(request.POST['diesel_quantity'])}L @ {diesel_update.diesel_price} "
                Audit_Trail.objects.create(company=request.user.company, service_station=service_station,
                                           user=request.user, action=action, reference=reference,
                                           reference_id=reference_id)
                return redirect('users:allocate')
            else:
                action = 'Allocation of Diesel'
                FuelAllocation.objects.create(company=request.user.company, action=action,
                                              diesel_price=diesel_update.diesel_price,
                                              diesel_quantity=request.POST['diesel_quantity'],
                                              sub_type=diesel_update.sub_type, cash=request.POST['cash'],
                                              usd=request.POST['usd'], swipe=request.POST['swipe'],
                                              ecocash=request.POST['ecocash'],
                                              allocated_subsidiary_id=diesel_update.relationship_id)

                service_station = Subsidiaries.objects.filter(id=diesel_update.relationship_id).first()
                reference = 'fuel allocation'
                reference_id = diesel_update.id
                action = f"You have allocated diesel quantity of {int(request.POST['diesel_quantity'])}L @ {diesel_update.diesel_price} "
                Audit_Trail.objects.create(company=request.user.company, service_station=service_station,
                                           user=request.user, action=action, reference=reference,
                                           reference_id=reference_id)
                messages.warning(request,
                                 'Please go to Depot or Station staff to assign a station representative before you allocate fuel again')
                return redirect('users:allocate')


        else:
            messages.success(request, 'Fuel object does not exists')
            return redirect('users:allocate')
